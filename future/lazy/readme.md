# (Lazy) Future

## –ü—Ä–µ—Ä–µ–∫–≤–∏–∑–∏—Ç—ã

- [future/fun](/tasks/future/fun)
- [sched/intrusive](/tasks/sched/intrusive)
- [—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è] [sched/ws_thread_pool](/tasks/sched/ws_thread_pool)

---

–í —ç—Ç–æ–π –∑–∞–¥–∞—á–µ –º—ã –Ω–∞–ø–∏—à–µ–º _–ª–µ–Ω–∏–≤—É—é_ (_lazy_) —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ—å—é—á.

–õ–µ–Ω–∏–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äì —ç—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–Ω–∞ –∏–∑–±–∞–≤–∏—Ç —Ñ—å—é—á–∏ –æ—Ç –ª–∏—à–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –ø–∞–º—è—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –≤ _—ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π_ (_eager_, _–±–æ–¥—Ä–æ–π_, _–∂–∞–¥–Ω–æ–π_) —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

–ö–∞–∫ –∏ –≤—Å—è–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –ª–µ–Ω–∏–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è [—Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ](https://en.wikipedia.org/wiki/Church%E2%80%93Rosser_theorem), –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–∞—é—â–∏—Ö—Å—è –ø—Ä–æ–≥—Ä–∞–º–º, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ.

## –ü—Ä–∏–º–µ—Ä

```cpp
// –ó–¥–µ—Å—å f ‚Äì thunk, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π –∑–∞–ø—É—Å–∫ –ª—è–º–±–¥—ã –≤ –ø—É–ª–µ –ø–æ—Ç–æ–∫–æ–≤
future::Future<int> auto f = future::Submit(pool, [] {
  return 7;
});

// <- –ü–æ–∫–∞ –∑–∞–¥–∞—á–∞ –Ω–µ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤

// –¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä `Get` —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ thunk-–∞ / –∑–∞–¥–∞—á–∞ —Å –ª—è–º–±–¥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å—ã–ª–∞–µ—Ç—Å—è –≤ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤
auto v = future::Get(std::move(f));
fmt::println("v = {}", v);  // –ü–µ—á–∞—Ç–∞–µ—Ç 7
```

## References

–°–Ω–∞—á–∞–ª–∞ ‚Äì –ø–æ–ª–µ–∑–Ω–∞—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ —Ç–µ–æ—Ä–∏—è:

#### Haskell

- [A History of Haskell: being lazy with class](https://www.youtube.com/watch?v=06x8Wf2r2Mc) ([—Å—Ç–∞—Ç—å—è](https://www.microsoft.com/en-us/research/wp-content/uploads/2016/07/history.pdf)) by [Simon Peyton Jones](https://en.wikipedia.org/wiki/Simon_Peyton_Jones)

##### Laziness

- [Lazy evaluation](https://wiki.haskell.org/Lazy_evaluation), [Thunk](https://wiki.haskell.org/Thunk)
- [The Incomplete Guide to Lazy Evaluation (in Haskell)](https://apfelmus.nfshost.com/articles/lazy-eval.html)

##### Semantics

- [Non-strict semantics](https://wiki.haskell.org/Non-strict_semantics)
- [Non-Strict Semantics of Haskell](https://apfelmus.nfshost.com/articles/non-strict-semantics.html)

#### Œª-calculus
- [A Brief and Informal Introduction to the Lambda Calculus](https://www.cs.yale.edu/homes/hudak/CS201S08/lambda.pdf)
- [Church‚ÄìRosser theorem](https://en.wikipedia.org/wiki/Church%E2%80%93Rosser_theorem)

## –õ–µ–Ω–∏–≤—ã–µ —Ñ—å—é—á–∏

### –ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å

–§—å—é—á–∞ ‚Äì —ç—Ç–æ _thunk_ (–¥–∞–ª–µ–µ ‚Äì –ø—Ä–æ—Å—Ç–æ _—Å–∞–Ω–∫_, "–∑–∞–º—ã—Å–µ–ª"), —Ç.–µ. –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –µ—â–µ –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–≤—à—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é / –±—É–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

–°–∞–Ω–∫ _—Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç—Å—è_ / –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç—É–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–ª–∞ _–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å_ (_demand_) –≤ –µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.

–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ / —Ñ–∞–π–±–µ—Ä / –∫–æ—Ä—É—Ç–∏–Ω–∞ —Ö–æ—á–µ—Ç "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å" —Ñ—å—é—á—É –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è _–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º_ (_continuation_). 
–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ ‚Äì —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –≤—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

–§–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–Ω–∫–∞ ‚Äì —ç—Ç–æ:
1) _–º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è_ (–æ–ø–µ—Ä–∞—Ü–∏—è _materialize_) "–∑–∞–º—ã—Å–ª–∞" –≤ –≤–∏–¥–µ _–≤—ã—á–∏—Å–ª–µ–Ω–∏—è_ (_computation_) –∏ 
2) _–∑–∞–ø—É—Å–∫_ (–æ–ø–µ—Ä–∞—Ü–∏—è _start_) –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:

–ü—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ _computation_ –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –≤ –ø–∞–º—è—Ç–∏ (_pinned_).

–° –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º —Å–≤—è–∑–∞–Ω–æ _–º—É—Ç–∞–±–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ_ (_mutable state_), –≤ –∫–æ—Ç–æ—Ä–æ–µ –≤—Ö–æ–¥–∏—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫.

### –ö–æ–¥

–í—Å–µ –ø–æ–Ω—è—Ç–∏—è –º–æ–¥–µ–ª–∏ —è–≤–Ω–æ [–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã](exe/future/model) –≤ –∫–æ–¥–µ –≤ –≤–∏–¥–µ [–∫–æ–Ω—Ü–µ–ø—Ç–æ–≤](https://en.cppreference.com/w/cpp/language/constraints):

- [`Continuation<T>`](exe/future/model/cont.hpp)
- [`Thunk`](exe/future/model/thunk.hpp)
- [`Computation`](exe/future/model/comp.hpp)
- [`State`](exe/future/model/state.hpp)

### –§—å—é—á–∏

–¢–µ–ø–µ—Ä—å —Ñ—å—é—á–∞ ‚Äì –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª–∞—Å—Å, –∞ –∫–æ–Ω—Ü–µ–ø—Ç [`SomeFuture`](exe/future/type/future.hpp) (—Å–∏–Ω–æ–Ω–∏–º –¥–ª—è [`Thunk`](exe/future/model/thunk.hpp)) + –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π `Future<T>`.

–ü–ª–∞–Ω–∏—Ä—É—è —Ü–µ–ø–æ—á–∫—É —à–∞–≥–æ–≤ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–Ω—Å—Ç—Ä—É–∏—Ä—É–µ—Ç –≤ compile time –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—å—é—á—É (—Å–∞–Ω–∫):

```cpp
// –í —Ç–∏–ø–µ —Ñ—å—é—á–∏ f –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —à–∞–≥–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
future::Future<int> auto f = future::Just()
    | future::Via(pool)
    | future::Map([](Unit) {
        return 1;
      })
    | future::Map([](int v) {
        return v + 2;
      });  
```

#### Fallible

–ö–∞–∫ –∏ —Ä–∞–Ω—å—à–µ, –º—ã –¥–æ–±–∞–≤–∏–º `SomeTryFuture` + `TryFuture<T>` –¥–ª—è —Å–±–æ–π–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

### –¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä—ã

–í –ª–µ–Ω–∏–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å —Ñ—å—é—á / —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∫–∞–∂–¥—É—é —Ü–µ–ø–æ—á–∫—É —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä–æ–º:

–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä ‚Äì —ç—Ç–æ —à–∞–≥, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç—Å—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∞–Ω–∫–∞ / –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.

–ü–æ—ç—Ç–æ–º—É –≤ –ª–µ–Ω–∏–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º—ã –ø–µ—Ä–µ–∏–º–µ–Ω—É–µ–º `exe/future/terminate` –≤ `exe/future/run`.

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### Storage

**–ò–Ω—Ç—Ä—É–∑–∏–≤–Ω–æ—Å—Ç—å** –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞—Ö –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–≤ –¥–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äì —Ñ—å—é—á–∞–º) –≤—ã–±–∏—Ä–∞—Ç—å —Å—Ç–æ—Ä–∞–¥–∂ (—Å—Ç–µ–∫ –∏–ª–∏ –∫—É—á–∞) –¥–ª—è –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `Submit` ‚Äì —Å—Ç–æ—Ä–∞–¥–∂ –¥–ª—è –ª—è–º–±–¥—ã —Å –∫–æ–¥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

**–õ–µ–Ω–∏–≤–æ—Å—Ç—å** –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—å—é—á –æ—Ç–ª–æ–∂–∏—Ç—å –≤—ã–±–æ—Ä —Å—Ç–æ—Ä–∞–¥–∂–∞ –¥–ª—è –∑–∞–¥–∞—á–∏ –¥–æ —Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ —ç—Ç–æ—Ç –≤—ã–±–æ—Ä –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ, —Ç.–µ. –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä–∞!

##### `Get`

–î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä–∞ (`Get` –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤, `Await` –¥–ª—è —Ñ–∞–π–±–µ—Ä–æ–≤ –∏ `co_await` –¥–ª—è stackless –∫–æ—Ä—É—Ç–∏–Ω) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
–ø–æ–ª–æ–∂–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç–µ–∫–æ–≤—ã–π —Ñ—Ä–µ–π–º `Get` / `Await` / –∫–æ—Ä—É—Ç–∏–Ω—ã. 

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∏–∑ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–∏—Ä–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ (–ø—Ä–∏—á–µ–º –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):

```cpp
// –í —ç—Ç–æ–º —Å–Ω–∏–ø–ø–µ—Ç–µ –Ω–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –ø–∞–º—è—Ç–∏!

{
  auto f = future::Submit(pool, [] {
    return 42;
  });

  auto v = future::Get(std::move(f));  // <- –†–∞–∑—Ä—É—à–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–¥–∞—á–∏ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–æ —Å –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
}
```

##### `Detach`

–î–ª—è `Detach` –ø—Ä–∏–¥–µ—Ç—Å—è —É–ø–∞–∫–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏–π—Å—è "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä" –Ω–∞ –∫—É—á–µ: –ø—É—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è, –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ.

#### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, 
–∞ –∑–Ω–∞—á–∏—Ç —Ä–∞–Ω–¥–µ–≤—É –º–µ–∂–¥—É –ø—Ä–æ–¥—å—é—Å–µ—Ä–æ–º –∏ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–º –≤ –ª–µ–Ω–∏–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –ª–µ–Ω–∏–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—å—é—á –æ—Å—Ç–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å –Ω–µ–¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º –Ω–∞ —É—Ä–æ–≤–Ω–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∞—Ö,
- –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø—Ä–∏–º–∏—Ç–∏–≤–∞—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

#### –†–µ–∑—É–ª—å—Ç–∞—Ç 

–ú—ã –ø–æ–ª—É—á–∏–ª–∏ **zero-cost** futures!

## –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã

–õ–µ–Ω–∏–≤—ã–º —Ñ—å—é—á–∞–º –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã:

---

### üëâ  `Box`

–ó–∞–≥–æ–ª–æ–≤–æ–∫: [`combine/seq/box.hpp`](exe/future/combine/seq/box.hpp)

–°—Ç–∏—Ä–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø —Å–∞–Ω–∫–∞ –¥–æ —Ç–∏–ø–∞ `BoxedFuture<T>`.

```cpp
auto f = future::Submit(pool, [] {
  return 42;
}) | future::Box();
```

–ò–ª–∏

```cpp
// Auto-boxing
future::BoxedFuture<int> f = future::Value(7);
```

#### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

–ë–æ–∫—Å–∏–Ω–≥ –Ω–µ–æ–±—Ö–æ–¥–∏–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º:

```cpp
struct IAsyncReader {
  virtual ~IAsyncReader() = default;
  
  // –ù–µ –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–ø—Ç Future<size_t>, –¥–æ–ª–∂–Ω—ã —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø
  virtual exe::future::BoxedFuture<Result<size_t>> ReadSome(std::span<std::byte> buffer) = 0;
};
```

---

### üëâ  `Start`

–ó–∞–≥–æ–ª–æ–≤–æ–∫: [`combine/seq/start.hpp`](exe/future/combine/seq/start.hpp)

–§–æ—Ä—Å–∏—Ä—É–µ—Ç —Å–∞–Ω–∫ / —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ª–µ–Ω–∏–≤—É—é —Ñ—å—é—á—É –≤ —ç–Ω–µ—Ä–≥–∏—á–Ω—É—é / —Å—Ç–∞—Ä—Ç—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.

```cpp
future::Future<int> auto f = future::Submit(pool, [] {
  return 7;
}) | future::Start();  // <- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤

// <- –ó–∞–¥–∞—á–∞ —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –≤ –ø—É–ª
```

–°–∏–Ω–æ–Ω–∏–º: `future::Force()`

#### Bang (!)

–ó–∞–≥–æ–ª–æ–≤–æ–∫: [`syntax/bang.hpp`](exe/future/syntax/bang.hpp)

–ü–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å [bang patterns –≤ Haskell](https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/strict.html), –ø–æ–¥–¥–µ—Ä–∂–∏–º –¥–ª—è —Ñ—å—é—á [–æ–ø–µ—Ä–∞—Ç–æ—Ä `!` (_bang_)](exe/future/syntax/bang.hpp):

```cpp
// !f —á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ "bang f", –æ–∑–Ω–∞—á–∞–µ—Ç f | Force()
auto f = !future::Submit(pool, [] {
  return 7;
});
```

## References

- [Zero-cost futures in Rust](https://aturon.github.io/tech/2016/08/11/futures/), [Designing futures for Rust](https://aturon.github.io/tech/2016/09/07/futures-design/)
- [Senders (`std::execution`)](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2024/p2300r9.html)

---

## –ó–∞–¥–∞–Ω–∏–µ

- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Submit`
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Get` –∏ `Detach`
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Just`, `Via`, `Map`, –ø–µ—Ä–µ–ø–∏—à–∏—Ç–µ `Submit`
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `MapOk`, `AndThen` –∏ `OrElse` –¥–ª—è `TryFuture`  
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Flatten`
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Contract`
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Both` –∏ `First`
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ `Box`, `Start`  
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –†–µ–∞–ª–∏–∑—É–π—Ç–µ `FirstOk` –∏ `BothOk`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

#### `Materialize`

–ò–∑–±–∞–≤—å—Ç–µ—Å—å –æ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–π –≤ `Materialize`.

#### Future-local / Mutable state 

–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π mutable state, –∫–æ—Ç–æ—Ä—ã–π –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø–æ–∑–≤–æ–ª—è–ª –±—ã
—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∞ `Map`.

#### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (`Event`, `Mutex`, `WaitGroup`),
–∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —Å–æ stackful —Ñ–∞–π–±–µ—Ä–∞–º–∏, —Ç–∞–∫ –∏ —Å–æ stackless –∫–æ—Ä—É—Ç–∏–Ω–∞–º–∏.

#### Boxing

–ù–µ –¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –ø—Ä–∏ –±–æ–∫—Å–∏–Ω–≥–µ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π —Ñ—å—é—á–∏.

–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ small future optimization.

### –ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- –ú–∞—Ä–∫–∏—Ä—É–π—Ç–µ —Å–∞–Ω–∫–∏ [`[[nodiscard]]`](https://en.cppreference.com/w/cpp/language/attributes/nodiscard)
- –ó–∞–ø—Ä–µ—Ç–∏—Ç–µ —Å–∞–Ω–∫–∞–º –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è

#### –¢–∏–ø—ã

–î–ª—è –ø–µ—á–∞—Ç–∏ —Ç–∏–ø–æ–≤ —Å–∞–Ω–∫–æ–≤ / –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```cpp
template <typename T>
void PrintTypeOf(T&) {
  fmt::println("{}", __PRETTY_FUNCTION__);
}
```